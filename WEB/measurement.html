<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý đơn vị tính</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="DataTables/datatables.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="DataTables/datatables.min.js"></script>
  <script src="logout.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="sidebar bg-dark text-white">
  <h2 class="text-center py-3">CRM System</h2>
  <a href="index.html" class="nav-link px-3 " data-feature="Báo cáo"> <i class="bi bi-house-door me-2"></i>Trang chủ</a>

  <a class="nav-link px-3  " data-bs-toggle="collapse" data-feature="Quản lý khách hàng" href="#customerMenu" >
    <i class="bi bi-people me-2"></i>Khách Hàng <i class="bi bi-caret-down-fill float-end"></i>
  </a>
  <div class="collapse" id="customerMenu">
    <a href="customers.html">Thông tin khách hàng</a>
    <a href="cskh.html">Chăm sóc khách hàng</a>
    <a href="customerstype.html">Loại khách hàng</a>
    <a href="more.html">Dữ liệu tuỳ chỉnh</a>
  </div>
  <a href="user.html" class="nav-link px-3" id="nav-manager" ><i class="bi bi-person-workspace me-2"></i>Nhân Viên</a>
  <a href="orders.html" class="nav-link px-3"  id="nav-order"><i class="bi bi-bag-check me-2"></i>Đơn Hàng</a>
  <a class="nav-link px-3 active bg-primary text-white" id="nav-product" data-bs-toggle="collapse" href="#productMenu" >
  <i class="bi bi-box-seam me-2" ></i>Sản Phẩm <i class="bi bi-caret-down-fill float-end"></i>
  </a>
      <div class="collapse" id="productMenu">
      <a href="products.html">Thông tin sản phẩm</a>
      <a href="measurement.html">Loại đơn vị tính</a>
      </div>
  <a href="work.html" class="nav-link px-3"  id="nav-work"><i class="bi bi-list-task me-2"></i>Công việc</a> 
  <a href="apointment.html" class="nav-link px-3 " id="nav-apointment"><i class="bi bi-calendar-check"></i> Lịch hẹn</a>  
   <div class="mt-auto">
      <a  id="returnBtn" class="nav-link px-3 outline" href="ADMIN/business.html">
        <button class="btn btn-outline-danger mb-3 ms-2"><i class="bi bi-box-arrow-right me-2"></i>ADMIN WEB</button>
      </a>
    </div>
</div>  
        
  <div class="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Danh sách đơn vị tính</h2>
      <div class="dropdown" style="display:flex; ">
        <a id="userNameDisplay" class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: black; display: flex; align-items: center;">
          <i class="bi bi-person-circle fs-4 text-primary"></i>
            Dropdown link
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="profile.html">Action</a></li>
          <li><a class="dropdown-item" href="pass.html">Đổi mật khẩu</a></li>
          <li id="logoutBtn"><a class="dropdown-item" href="#"> <i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
        </ul>
      </div>
    </div>
    <hr />
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addMeasurementModal">Thêm đơn vị tính</button>
    <table class="table table-bordered" id="orderTable">
      <thead>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<!-- Modal Thêm -->
<div class="modal fade" id="addMeasurementModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="addMeasurementForm">
          <div class="modal-header">
            <h5 class="modal-title">Thêm đơn vị tính</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">Tên đơn vị tính</label><input type="text" class="form-control" name="name" required></div>
            <div class="mb-3"><label class="form-label">Mô tả</label> <textarea class="form-control auto-resize" name="description" rows="1" required></textarea></div>
                <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Hoặc nhập bằng Excel</h6>
                <a href="template/measurement_template.xlsx" download class="text-decoration-underline small text-primary">
                  <i class="bi bi-download"></i> Tải mẫu Excel
                </a>
              </div>
              <div class="d-grid gap-2">
                <input type="file" class="form-control" id="excelFileInput" accept=".xlsx, .xls">
                <button type="button" class="btn btn-secondary" id="importExcelBtn">
                  <i class="bi bi-upload"></i> Nhập từ Excel
                </button>
              </div>              
            </div>
        </div>
          <div class="modal-footer"><button type="submit" class="btn btn-success">Thêm mới</button></div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal Sửa -->
  <div class="modal fade" id="editMeasurementModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="editMeasurementForm">
          <input type="hidden" name="id_measurement">
          <div class="modal-header">
            <h5 class="modal-title">Sửa đơn vị tính</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3"><label class="form-label">Tên đơn vị tính</label><input type="text" class="form-control" name="name" required></div>
            <div class="mb-3"><label class="form-label">Mô tả</label> <textarea class="form-control auto-resize" name="description" rows="1" required></textarea></div>
          </div>
          <div class="modal-footer"><button type="submit" class="btn btn-primary">Cập nhật</button></div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   const id_business = localStorage.getItem('id_business') ;
    let dataTable;
function featchMeasurement() {
  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/get_measurement.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ id_business }),
    success: function (res) {
      if (res.status !== 'success') return Swal.fire('Lỗi', 'Không tải được danh sách đơn vị tính', 'error');;
          const tableData = res.data.map((measurement, i) => {
            const row = [
              i + 1, // STT
              measurement.id_measurement, 
              measurement.name, 
              measurement.description || '', 
              `
                <button class="btn btn-primary btn-sm edit-btn" data-id="${measurement.id_measurement}">Sửa</button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="${measurement.id_measurement}">Xóa</button>
              `
            ];
            return row;
          });
          if (!$.fn.DataTable.isDataTable('#orderTable')) {
            dataTableWork = $('#orderTable').DataTable({
              data: tableData,
              autoWidth: false,
              scrollX: true,
              fixedColumns: {
                right: 1  
              },
              layout: {
                topStart: {
                    buttons: [
                    {
                      extend: 'excelHtml5',
                      text: '<i class="bi bi-download"></i> Xuất Excel',
                      className: 'btn btn-outline-primary mb-3 ms-2',
                      exportOptions: {
                      // Loại bỏ cột cuối cùng
                      columns: ':not(:last-child)'
                      // Hoặc chỉ định index: columns: [0,1,2,3] 
                      }
                    },
                  ]
                }
               },
              columns: [
                { title: 'STT' },
                { title: 'Mã đơn vị tính' },
                { title: 'Tên đơn vị tính' },
                { title: 'Mô tả' },
                { title: 'Hành động', orderable: false, width: '120px'  }
              ],
              language: {
                searchPlaceholder: "Nhập thông tin muốn tìm kiếm",
                search: "Tìm kiếm:",
              }
            });
          } else {
            dataTableWork.clear();
            dataTableWork.rows.add(tableData);
            dataTableWork.draw(false);
          }
          $('#loadingIndicator').addClass('d-none');
          $('#customerContent').removeClass('d-none').addClass('fade-in');

    },
    error: function () {
      Swal.fire('Lỗi', 'Không thể tải danh sách đơn vị tính', 'error');
    }
  });
}

$('#addMeasurementForm').submit(function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    data.id_business = id_business;
    $.ajax({
        url: 'https://khaituanminh.atwebpages.com/api/add_measurement.php',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
        if (res.status === 'success') {
            featchMeasurement();
            bootstrap.Modal.getInstance(document.getElementById('addMeasurementModal')).hide();
            Swal.fire('Thành công!', 'Đã thêm đơn vị tính.', 'success');
        } else {
            Swal.fire('Lỗi', res.message, 'error');
        }
        }
    });
    });

    $(document).on('click', '.edit-btn', function() {
    const id   = $(this).data('id');
    const $tr  = $(this).closest('tr');
    const name = $tr.children().eq(2).text().trim();
    const desc = $tr.children().eq(3).text().trim();
    const $form = $('#editMeasurementForm');
    $form.find('[name=id_measurement]').val(id);
    $form.find('[name=name]').val(name);
    $form.find('[name=description]').val(desc);
    new bootstrap.Modal($('#editMeasurementModal')).show();
  });

 
  $('#editMeasurementForm').submit(function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this));
    $.ajax({
      url: 'https://khaituanminh.atwebpages.com/api/update_measurement.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(res) {
        if (res.status === 'success') {
          bootstrap.Modal.getInstance($('#editMeasurementModal')).hide();
          Swal.fire('Thành công!', 'Đã cập nhật đơn vị tính.', 'success');
          featchMeasurement();
        } else {
          Swal.fire('Lỗi', res.message, 'error');
        }
      },
      error: function() {
        Swal.fire('Lỗi', 'Không thể cập nhật đơn vị tính.', 'error');
      }
    });
  });


    $(document).on('click', '.delete-btn', function() {
      const id = $(this).data('id');
      Swal.fire({
        title: 'Bạn chắc chắn muốn xóa?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: 'https://khaituanminh.atwebpages.com/api/del_measurement.php',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id_measurement: id }),
            success: function(res) {
              if (res.status === 'success') {
                featchMeasurement();
                Swal.fire('Đã xóa!', '', 'success');
              } else {
                Swal.fire('Lỗi', res.message, 'error');
              }
            },
            error: function () {
          Swal.fire('Lỗi', 'Không thể xóa đơn vị tính', 'error');
        }
          });
        }
      });
    });


// Import từ Excel
$('#importExcelBtn').click(function() {
  const fileInput = $('#excelFileInput')[0];
  if (!fileInput.files.length) return Swal.fire('Lỗi','Vui lòng chọn file Excel','error');
  const reader = new FileReader();
  reader.onload = function(e) {
    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });
    if (rows.length<2) return Swal.fire('Lỗi','File Excel không có dữ liệu.','error');
    const dataList = rows.slice(1).map(r=>({ name:r[0]?.trim(), description:r[1]?.trim() }));
    let ok=0, fail=0;
    function sendNext(i) {
      if (i>=dataList.length) {
        return Swal.fire('Hoàn tất',`✅ Thành công: ${ok} | ❌ Thất bại: ${fail}`,'info').then(()=>{ featchMeasurement(); bootstrap.Modal.getInstance($('#addMeasurementModal')).hide(); $('#addMeasurementForm')[0].reset(); $('#excelFileInput').val(''); });
      }
      const item=dataList[i];
      if (!item.name) { fail++; return sendNext(i+1); }
      $.ajax({ url:'https://khaituanminh.atwebpages.com/api/add_measurement.php', method:'POST', contentType:'application/json', data:JSON.stringify({...item,id_business}), success(res){ if(res.status==='success') ok++; else fail++; sendNext(i+1); }, error(){ fail++; sendNext(i+1);} });
    }
    sendNext(0);
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
});

    
    $(document).ready(function() {
      featchMeasurement();
    $('#addMeasurementModal').on('hidden.bs.modal', function () {
      $('#addMeasurementForm')[0].reset();
    });

    $('#editMeasurementModal').on('hidden.bs.modal', function () {
      $('#editMeasurementForm')[0].reset();
    });

    });
  </script>
</body>
</html>
