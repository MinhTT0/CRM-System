<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Khách hàng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css"/>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
  <script src="logout.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="style.css" />

</head>
<body>
<div class="sidebar bg-dark text-white">
  <h2 class="text-center py-3">CRM System</h2>
  <a href="index.html" class="nav-link px-3 " data-feature="Báo cáo"> <i class="bi bi-house-door me-2"></i>Trang chủ</a>

  <a class="nav-link px-3 active bg-primary text-white " data-bs-toggle="collapse" data-feature="Quản lý khách hàng" href="#customerMenu" >
    <i class="bi bi-people me-2"></i>Khách Hàng <i class="bi bi-caret-down-fill float-end"></i>
  </a>
  <div class="collapse" id="customerMenu">
    <a href="customers.html">Thông tin khách hàng</a>
    <a href="cskh.html">Chăm sóc khách hàng</a>
    <a href="customerstype.html">Loại khách hàng</a>
    <a href="more.html">Dữ liệu tuỳ chỉnh</a>
  </div>
  <a href="user.html" class="nav-link px-3" id="nav-manager" ><i class="bi bi-person-workspace me-2"></i>Nhân Viên</a>
  <a href="orders.html" class="nav-link px-3"  id="nav-order"><i class="bi bi-bag-check me-2"></i>Đơn Hàng</a>
  <a class="nav-link px-3" id="nav-product" data-bs-toggle="collapse" href="#productMenu" >
  <i class="bi bi-box-seam me-2" ></i>Sản Phẩm <i class="bi bi-caret-down-fill float-end"></i>
  </a>
      <div class="collapse" id="productMenu">
      <a href="products.html">Thông tin sản phẩm</a>
      <a href="measurement.html">Loại đơn vị tính</a>
      </div>
  <a href="work.html" class="nav-link px-3"  id="nav-work"><i class="bi bi-list-task me-2"></i>Công việc</a> 
  <a href="apointment.html" class="nav-link px-3 " id="nav-apointment"><i class="bi bi-calendar-check"></i> Lịch hẹn</a>  
  <div class="mt-auto">
      <a  id="returnBtn" class="nav-link px-3 outline" href="ADMIN/business.html">
        <button class="btn btn-outline-danger mb-3 ms-2"><i class="bi bi-box-arrow-right me-2"></i>ADMIN WEB</button>
      </a>
    </div>
</div>  

<div class="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Quản lý thông tin tuỳ chỉnh</h2>
      <div class="dropdown" style="display:flex; ">
        <a id="userNameDisplay" class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: black; display: flex; align-items: center;">
          <i class="bi bi-person-circle fs-4 text-primary"></i>
            Dropdown link
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">Action</a></li>
          <li><a class="dropdown-item" href="#">Đổi mật khẩu</a></li>
          <li id="logoutBtn"><a class="dropdown-item" href="#"> <i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
        </ul>
      </div>
    </div>
    <hr>
    <div id="customerContent" class="d-none">
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addCustomerModal">Thêm thông tin</button>
  <button class="btn btn-outline-primary mb-3 ms-2" id="exportExcelBtn"><i class="bi bi-download"></i> Xuất Excel</button>
  <table class="table table-bordered" id="customerTable">
    <thead>
      <tr>
      <th>STT</th>
      <th>Mã dữ liệu</th>
      <th>Tên dữ liệu</th>
      <!-- <th>Loại dữ liệu</th> -->
      <th>Mô tả</th>
      <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>
    <div id="loadingIndicator" class="text-center py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Đang tải dữ liệu...</p>
    </div>  
  </div>
  <!-- Modal Thêm -->
<div class="modal fade" id="addCustomerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> 
    <div class="modal-content">
      <form id="addCustomerForm">
        <div class="modal-header">
          <h5 class="modal-title">Thêm Thông tin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Tên Thông tin</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <!-- <div class="mb-3">
                <label class="form-label">Loại dữ liệu</label>
                <input type="text" class="form-control" name="type" required>
              </div> -->
              <div class="mb-3">
                <label class="form-label">Mô tả</label>
                  <textarea class="form-control auto-resize" name="description" rows="1" required></textarea>
              </div>
              <div class="col-12">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Hoặc nhập bằng Excel</h6>
                <a href="template/measurement_template.xlsx" download class="text-decoration-underline small text-primary">
                  <i class="bi bi-download"></i> Tải mẫu Excel
                </a>
              </div>
              <div class="d-grid gap-2">
                <input type="file" class="form-control" id="excelFileInput" accept=".xlsx, .xls">
                <button type="button" class="btn btn-secondary" id="importExcelBtn">
                  <i class="bi bi-upload"></i> Nhập từ Excel
                </button>
              </div>              
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Thêm mới</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Sửa -->
<div class="modal fade" id="editCustomerModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="editCustomerForm">
        <input type="hidden" name="id_custominfo">
        <div class="modal-header">
          <h5 class="modal-title">Sửa Thông tin</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Tên Thông tin</label>
            <input type="text" class="form-control" name="name" id="name" required>
          </div>
          <!-- <div class="mb-3">
            <label class="form-label">Loại dữ liệu</label>
            <input type="text" class="form-control" name="type" id="type" required>
          </div> -->
          <div class="mb-3">
            <label class="form-label">Mô tả</label>
              <textarea class="form-control auto-resize" name="description"  id="description" rows="1" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Cập nhật</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const id_business = localStorage.getItem('id_business') ;

let dataTable;
function fetchCustomers() {
  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/get_custominfo.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ id_business }),
    success: function (res) {
      if (res.status !== 'success') return;
      const tableData = res.data.map((more, i) => {
        const row = [
          i + 1,
          more.id_custominfo,
          more.name,
          // more.type || '',
          more.description || '',
          `
            <button class="btn btn-primary btn-sm edit-btn" data-id="${more.id_custominfo}">Sửa</button>
            <button class="btn btn-danger btn-sm delete-btn" data-id="${more.id_custominfo}">Xóa</button>
          `
        ];
        return row;
      });
      if (!$.fn.DataTable.isDataTable('#customerTable')) {
        dataTable = $('#customerTable').DataTable({
          data: tableData,
});
      } else {
        dataTable.clear();
        dataTable.rows.add(tableData);
        dataTable.draw(false); 
      }
      $('#loadingIndicator').addClass('d-none');
      $('#customerContent').removeClass('d-none').addClass('fade-in');
    },
    error: function () {
      Swal.fire('Lỗi', 'Không thể tải danh sách khách hàng', 'error');
    }
  });
}

$('#addCustomerForm').submit(function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  data.id_business = id_business;
  data.type="text";
  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/set_custominfo.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data),
    success(res) {
      if (res.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
        Swal.fire('Thành công!', 'Đã thêm đữ liệu.', 'success');
        fetchCustomers();
      } else {
        Swal.fire('Lỗi', res.message, 'error');
      }
    },
    error() {
      Swal.fire('Lỗi', 'Không thể kết nối đến máy chủ.', 'error');
    }
  });
});
$(document).on('click', '.edit-btn', function() {
    const id = $(this).data('id');
    const row = $(this).closest('tr');
    const form = $('#editCustomerForm');
    form.find('[name=id_custominfo]').val(id);
    form.find('[name=name]').val(row.children().eq(2).text());
    form.find('[name=type]').val(row.children().eq(3).text());
    form.find('[name=description]').val(row.children().eq(4).text());
    const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
    modal.show();
});

$('#editCustomerForm').submit(function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(this));
  data.type="text";
  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/update_custom.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(data),
    success: function(res) {
      if (res.status === 'success') {
        bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
        Swal.fire('Thành công!', 'Cập nhật dữ liệu thành công.', 'success');
      
        fetchCustomers();
      } else {
        Swal.fire('Lỗi', res.message, 'error');
      }
    }
  });
});
  $(document).on('click', '.delete-btn', function() {
      const id = $(this).data('id');
      Swal.fire({
        title: 'Bạn chắc chắn muốn xóa?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xóa',
        cancelButtonText: 'Hủy'
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: 'https://khaituanminh.atwebpages.com/api/del_custom.php',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ id_custominfo: id, id_business }),
            success: function(res) {
              if (res.status === 'success') {
                fetchCustomers();
                Swal.fire('Đã xóa!', '', 'success');
              } else {
                Swal.fire('Lỗi', res.message, 'error');
              }
            },
            error: function () {
          Swal.fire('Lỗi', 'Không thể xóa dữ liệu. Có thể thông tin khách hàng đang được sử dụng ở nơi khác', 'error');
        }
          });
        }
      });
    });
  $(document).ready(function () {
   
    fetchCustomers();
    $('#addCustomerModal').on('hidden.bs.modal', function () {
      $('#addCustomerForm')[0].reset();
    });

    $('#editCustomerModal').on('hidden.bs.modal', function () {
      $('#editCustomerForm')[0].reset();
    });
});
//Nhập từ excel
$('#importExcelBtn').off('click').on('click', function () {
  const fileInput = document.getElementById('excelFileInput');
  if (!fileInput.files.length) {
    Swal.fire('Lỗi', 'Vui lòng chọn một tệp Excel', 'error');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
      if (jsonData.length < 2) {
        Swal.fire('Lỗi', 'File Excel không có dữ liệu.', 'error');
        return;
      }
      const header = jsonData[0]; 
      const today = new Date().toISOString().split('T')[0];
      const customers = jsonData.slice(1).map((row, i) => {
        const customer = {
          name: row[0],
          type: row[1],
          description: row[2],
        };
        return customer;
      });
      let successCount = 0;
      let failCount = 0;
      function sendNext(index) {
        if (index >= customers.length) {
          Swal.fire({
            title: 'Hoàn tất',
            text: `✅ Thành công: ${successCount} | ❌ Thất bại: ${failCount}`,
            icon: 'info'
          }).then(() => {   
            fetchCustomers();
            bootstrap.Modal.getInstance(document.getElementById('addCustomerModal')).hide();
            $('#addCustomerForm')[0].reset();
            $('#excelFileInput').val('');
          });
          return;
        }
        const cus = customers[index];
        // if (!cus.name || !cus.phone || !cus.id_type) {
        //   console.warn(`❌ Dòng ${index + 2} lỗi: thiếu thông tin bắt buộc`, cus);
        //   failCount++;
        //   sendNext(index + 1);
        //   return;
        // }
        const dataToSend = {
          ...cus,
          id_business: id_business
        };
        $.ajax({
          url: 'https://khaituanminh.atwebpages.com/api/set_custominfo.php',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(dataToSend),
          success: function (res) {
            if (res.status === 'success') successCount++;
            else {
              console.warn(`❌ Lỗi API dòng ${index + 2}:`, res.message);
              failCount++;
            }
            sendNext(index + 1);
          },
          error: function () {
            console.error(`❌ Kết nối lỗi ở dòng ${index + 2}`);
            failCount++;
            sendNext(index + 1);
          }
        });
      }

      sendNext(0);
    } catch (err) {
      console.error(err);
      Swal.fire('Lỗi', 'Không thể đọc file Excel.', 'error');
    }
  };

  reader.readAsArrayBuffer(file);
});


// xuất file excel
$('#exportExcelBtn').click(function () {
  const table = $('#customerTable').DataTable();
  const rows = Array.from(table.rows({ search: 'applied' }).nodes()); 
  const headers = [];
  $('#customerTable thead th').each(function (i) {
    if (i !== 0 && i !== $('#customerTable thead th').length - 1) {
      headers.push($(this).text().trim());
    }
  });

  const data = [];
  rows.forEach(row => {
    const rowData = [];
    const cells = $(row).find('td');
    for (let i = 1; i < cells.length - 1; i++) {
      rowData.push($(cells[i]).text().trim()); 
    }
    data.push(rowData);
  });
  const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'DanhSachKhachHang');

  const now = new Date();
  const fileName = `ThongTinTuyChinh_${now.getDate().toString().padStart(2, '0')}-${(now.getMonth() + 1)
    .toString()
    .padStart(2, '0')}-${now.getFullYear()}.xlsx`;

  XLSX.writeFile(wb, fileName);
});




  </script>
</body>
</html>
