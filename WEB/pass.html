<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đổi mật khẩu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="logout.js"></script>
</head>
<body>
<div class="sidebar bg-dark text-white">
  <h2 class="text-center py-3">CRM System</h2>
  <a href="index.html" class="nav-link px-3 " data-feature="Báo cáo"> <i class="bi bi-house-door me-2"></i>Trang chủ</a>

  <a class="nav-link px-3  " data-bs-toggle="collapse" data-feature="Quản lý khách hàng" href="#customerMenu" >
    <i class="bi bi-people me-2"></i>Khách Hàng <i class="bi bi-caret-down-fill float-end"></i>
  </a>
  <div class="collapse" id="customerMenu">
    <a href="customers.html">Thông tin khách hàng</a>
    <a href="cskh.html">Chăm sóc khách hàng</a>
    <a href="customerstype.html">Loại khách hàng</a>
    <a href="more.html">Dữ liệu tuỳ chỉnh</a>
  </div>
  <a href="user.html" class="nav-link px-3" id="nav-manager" ><i class="bi bi-person-workspace me-2"></i>Nhân Viên</a>
  <a href="orders.html" class="nav-link px-3"  id="nav-order"><i class="bi bi-bag-check me-2"></i>Đơn Hàng</a>
  <a class="nav-link px-3" id="nav-product" data-bs-toggle="collapse" href="#productMenu" >
  <i class="bi bi-box-seam me-2" ></i>Sản Phẩm <i class="bi bi-caret-down-fill float-end"></i>
  </a>
      <div class="collapse" id="productMenu">
      <a href="products.html">Thông tin sản phẩm</a>
      <a href="measurement.html">Loại đơn vị tính</a>
      </div>
  <a href="work.html" class="nav-link px-3"  id="nav-work"><i class="bi bi-list-task me-2"></i>Công việc</a> 
  <a href="apointment.html" class="nav-link px-3 " id="nav-apointment"><i class="bi bi-calendar-check"></i> Lịch hẹn</a>     
</div>  
      
  <div class="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Đổi mật khẩu</h2>
      <div class="dropdown">
        <a id="userNameDisplay" class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-person-circle text-primary"></i> Tài khoản
        </a>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="profile.html">Thông tin tài khoản</a></li>
          <li><a class="dropdown-item" href="pass.html">Đổi mật khẩu</a></li>
          <li id="logoutBtn"><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
        </ul>
      </div>
    </div>
    <hr>

    <div class="d-flex justify-content-center">
        <form id="changePasswordForm" class="mb-3" style="max-width: 400px; width:100%;">
          <!-- <div class="mb-3">
            <label for="oldPassword" class="form-label">Mật khẩu cũ</label>
            <input type="password" class="form-control" id="oldPassword" name="oldPassword" required>
          </div> -->
          <div class="mb-3 position-relative">
            <label for="password" class="form-label">Mật khẩu</label>
            <input type="password" class="form-control" id="password" name="passcword" required>
            <i class="bi bi-eye-slash toggle-password" id="togglePassword"
               style="position:absolute; top:38px; right:10px; cursor:pointer;"></i>
          </div>
          
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
          </div>
          <button type="submit" class="btn btn-primary">Xác nhận</button>
        </form>
      </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Toggle hiển thị mật khẩu
    $('#togglePassword').on('click', function () {
      const passwordInput = $('#password');
      const type = passwordInput.attr('type') === 'password' ? 'text' : 'password';
      passwordInput.attr('type', type);
  
      // Đổi icon
      $(this).toggleClass('bi-eye');
      $(this).toggleClass('bi-eye-slash');
    });
  </script>
  <script>
    const id_account = localStorage.getItem("id_account");
    $('#changePasswordForm').submit(function(e) {
      e.preventDefault();
    //   const oldPwd = $('#oldPassword').val().trim();
      const newPwd = $('#password').val().trim();
      const confirmPwd = $('#confirmPassword').val().trim();

      if (newPwd !== confirmPwd) {
        return Swal.fire('Lỗi', 'Mật khẩu mới và xác nhận không khớp', 'error');
      }

      const data = {
         id_account: localStorage.getItem("id_account"),
        // old_password: oldPwd,
        password: newPwd
      };

      $.ajax({
        url: 'https://khaituanminh.atwebpages.com/api/change_password.php',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(res) {
          if (res.status === 'success') {
            Swal.fire('Thành công', 'Đã đổi mật khẩu thành công', 'success');
          } else {
            Swal.fire('Lỗi', res.message || 'Đổi mật khẩu thất bại', 'error');
          }
        },
        error: function() {
          Swal.fire('Lỗi', 'Không thể kết nối đến máy chủ', 'error');
        }
      });
    });
  </script>
</body>
</html>
