<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Danh sách Đơn hàng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
  <script src="logout.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="sidebar bg-dark text-white">
  <h2 class="text-center py-3">CRM System</h2>
  <a href="index.html" class="nav-link px-3 " data-feature="Báo cáo"> <i class="bi bi-house-door me-2"></i>Trang chủ</a>

  <a class="nav-link px-3  " data-bs-toggle="collapse" data-feature="Quản lý khách hàng" href="#customerMenu" >
    <i class="bi bi-people me-2"></i>Khách Hàng <i class="bi bi-caret-down-fill float-end"></i>
  </a>
  <div class="collapse" id="customerMenu">
    <a href="customers.html">Thông tin khách hàng</a>
    <a href="cskh.html">Chăm sóc khách hàng</a>
    <a href="customerstype.html">Loại khách hàng</a>
    <a href="more.html">Dữ liệu tuỳ chỉnh</a>
  </div>
  <a href="user.html" class="nav-link px-3" id="nav-manager" ><i class="bi bi-person-workspace me-2"></i>Nhân Viên</a>
  <a href="orders.html" class="nav-link px-3 active bg-primary text-white"  id="nav-order"><i class="bi bi-bag-check me-2"></i>Đơn Hàng</a>
        
  <a class="nav-link px-3" id="nav-product" data-bs-toggle="collapse" href="#productMenu" >
  <i class="bi bi-box-seam me-2" ></i>Sản Phẩm <i class="bi bi-caret-down-fill float-end"></i>
  </a>
      <div class="collapse" id="productMenu">
      <a href="products.html">Thông tin sản phẩm</a>
      <a href="measurement.html">Loại đơn vị tính</a>
      </div>
  <a href="work.html" class="nav-link px-3"  id="nav-work"><i class="bi bi-list-task me-2"></i>Công việc</a> 
  <a href="apointment.html" class="nav-link px-3 " id="nav-apointment"><i class="bi bi-calendar-check"></i> Lịch hẹn</a>  
   <div class="mt-auto">
      <a  id="returnBtn" class="nav-link px-3 outline" href="ADMIN/business.html">
        <button class="btn btn-outline-danger mb-3 ms-2"><i class="bi bi-box-arrow-right me-2"></i>ADMIN WEB</button>
      </a>
    </div>
</div>  
<div class="content">
  <!-- Container ngang cho tiêu đề và dropdown -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Danh sách đơn hàng</h2>
    <div>
    <div class="d-flex align-items-center gap-3">
       <div class="dropdown" data-bs-auto-close="outside">
                  <a class="btn btn-light position-relative"
                     href="#"
                     id="notifDropdown"
                     data-bs-toggle="dropdown"
                     aria-expanded="false"
                     ata-bs-auto-close="outside">
                    <i class="bi bi-bell fs-4"></i>
                    <span id="notifBadge"
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                      0
                    </span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end p-2"
                      aria-labelledby="notifDropdown"
                      style="max-width:300px; max-height:400px; overflow:auto;">
                    <li class="text-center text-muted small">Đang tải...</li>
                  </ul>
                </div>
    <div class="dropdown" style="display:flex; ">
      <a id="userNameDisplay" class="btn btn-light dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: black; display: flex; align-items: center;">
        <i class="bi bi-person-circle fs-4 text-primary"></i>
          Dropdown link
      </a>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#profile.html">Thông tin tài khoản</a></li>
        <li><a class="dropdown-item" href="#password.html">Đổi mật khẩu</a></li>
        <li id="logoutBtn"><a class="dropdown-item" href="#"> <i class="bi bi-box-arrow-right"></i> Đăng xuất</a></li>
      </ul>
    </div>
  </div>
</div>
</div>
  <hr>
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addOrderModal">
    <i class="bi bi-plus-circle"></i> Thêm đơn hàng
    <button class="btn btn-outline-primary mb-3 ms-2" id="exportExcelBtn"><i class="bi bi-download"></i> Xuất Excel</button>
  </button>
    <div class="row mb-3">
    <div class="col-md-6">
      <strong>Tổng số đơn:</strong> <span id="totalOrders">0</span>
    </div>
    <div class="col-md-6">
      <strong>Tổng tiền:</strong> <span id="totalAmount">0 đ</span>
    </div>
  </div>
  <table class="table table-bordered" id="orderTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>Mã đơn hàng</th>
        <th>Người tạo đơn</th>
        <th>Tên khách hàng</th>
        <th>Ngày tạo</th>
        <th>Tổng tiền</th>
        <th style="width: 10%;">Chi tiết đơn hàng</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Chi tiết đơn hàng -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết đơn hàng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Khách hàng:</strong> <span id="detailCustomer"></span></p>
        <p><strong>Nhân viên xử lý:</strong> <span id="detailUser"></span></p>
        <p><strong>Ngày:</strong> <span id="detailDate"></span></p>
        <p><strong>Tổng tiền:</strong> <span id="detailTotal"></span> đ</p>
        <hr>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Tên sản phẩm</th>
              <th>Số lượng</th>
            </tr>
          </thead>
          <tbody id="orderProducts"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tạo Đơn hàng mới -->
<div class="modal fade" id="addOrderModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="createOrderForm">
        <div class="modal-header">
          <h5 class="modal-title">Tạo đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Khách hàng</label>
            <select class="form-select" name="id_customer" id="customerSelect" required style="width: 100%">
              <option value="">-- Chọn khách hàng --</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Nhân viên</label>
           <select class="form-select" name="id_user" id="userSelect" required style="width: 100%">
              <option value="">-- Chọn nhân viên </option>
            </select>
          </div>          
          <div class="mb-3">
            <label class="form-label">Ngày tạo</label>
            <input type="date" class="form-control" name="date" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Sản phẩm đã chọn</label>
            <button type="button" class="btn btn-outline-primary btn-sm" id="openProductModal">
              <i class="bi bi-plus-circle"></i> Chọn sản phẩm
            </button>
            
            <div id="productList" class="mt-2"></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Tổng tiền</label>
            <input type="number" class="form-control" name="total" id="totalAmountInput" readonly>
          </div>
          <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Hoặc nhập bằng Excel</h6>
                  <a href="template/orders_template.xlsx" download class="text-decoration-underline small text-primary">
                    <i class="bi bi-download"></i> Tải mẫu Excel
                  </a>
                </div>
                <div class="d-grid gap-2">
                  <input type="file" class="form-control" id="excelFileInput" accept=".xlsx, .xls">
                  <button type="button" class="btn btn-secondary" id="importExcelBtn">
                    <i class="bi bi-upload"></i> Nhập từ Excel
                  </button>
                </div>              
              </div>
       
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Tạo đơn hàng</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Chọn sản phẩm -->
<div class="modal fade" id="selectProductModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chọn sản phẩm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-bordered" id="productTable">
          <thead>
            <tr>
              <th>Chọn</th>
              <th>Tên sản phẩm</th>
              <th>Giá</th>
              <th>Số lượng</th>
              <th>Tổng giá tiền</th>
              
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-primary" id="confirmProductSelection">Xác nhận chọn</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.print/1.6.2/jQuery.print.min.js"></script>
<script>
  const id_business = localStorage.getItem("id_business");
  let customerList = [];
  let user=[];
  let productList =[];
  let orderDataTable = null;
  let count=0;
  let total=0;

function fetchOrders() {
  $.ajax({
    url: "https://khaituanminh.atwebpages.com/api/get_allorderbusiness.php",
    method: "POST",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({ id_business }),
    success: function (result) {
      if (result.status !== "success") return Swal.fire("Lỗi", result.message, "error");
      const orders = result.data.orders || [];
      console.log(orders)
      count = orders.length;
      const tableData = orders.map((order, index) => {
        const formattedTotal = Number(order.total).toLocaleString('vi-VN');
        total += order.total
        return [
          index + 1,
          order.id_order,
          order.user_name,
          order.customer_name,
          order.date,
          `${formattedTotal} đ`,
          `
            <button class="btn btn-info btn-sm text-white view-order " data-id="${order.id_order}">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-secondary btn-sm print-order ms-1" data-id="${order.id_order}"> 
        <i class="bi bi-printer"></i>
      </button>   
          `
        ];
      });
      console.log(count);
      console.log(total);

      $('#totalOrders').text(count);
      $('#totalAmount').text(total.toLocaleString('vi-VN')+' đ' );
      if (!$.fn.DataTable.isDataTable('#orderTable')) {
        orderDataTable = $('#orderTable').DataTable({
          data: tableData,
          language: {
        "info": "Hiển thị _START_ tới _END_ của _TOTAL_ đơn hàng",
  }
        });
      } else {
        orderDataTable.clear();
        orderDataTable.rows.add(tableData);
        orderDataTable.draw(false);
      }

      $('#loadingIndicator').addClass('d-none');
      $('#orderContent').removeClass('d-none').addClass('fade-in');
    },
    error: function () {
      Swal.fire("Lỗi", "Không thể kết nối đến máy chủ", "error");
    }
  });
}
function loadDropdownData() {
  const modal = $('#addOrderModal');
  let customerList = [];
  let userList     = [];
  let cskhMapping  = {};  

  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/get_cskh.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ id_business }),
    success(res) {
      if (res.status === 'success') {
        res.data.forEach(item => {
          if (item.users && item.users.length) {
            cskhMapping[item.id_customer] = item.users[0].id_user;
          }
        });
      }
      $.when(
        $.ajax({
          url: 'https://khaituanminh.atwebpages.com/api/get_alluser.php',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ id_business }),
          success(r) { if (r.status==='success') userList = r.data; }
        }),
        $.ajax({
          url: 'https://khaituanminh.atwebpages.com/api/get_customer.php',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ id_business }),
          success(r) { if (r.status==='success') customerList = r.data; }
        })
      ).done(initSelects);
    }
  });

  function renderCustomerOptions(list) {
    const $c = $('#customerSelect');
    $c.find('option').remove();
    $c.append(new Option('-- Chọn khách hàng --', ''));
    list.forEach(c => {
      $c.append(new Option(`${c.name} (Mã KH: ${c.id_customer})`, c.id_customer));
    });
    $c.trigger('change.select2');
  }

  function initSelects() {
    $('#userSelect').select2({
      dropdownParent: modal,
      placeholder: 'Chọn nhân viên',
      allowClear: true,
      data: userList.map(u => ({
        id:   u.id_user,
        text: `${u.name} (Mã NV: ${u.id_user})`
      }))
    });
    $('#customerSelect').select2({
      dropdownParent: modal,
      placeholder: 'Chọn khách hàng',
      allowClear: true
    });
    renderCustomerOptions(customerList);
    bindEvents();
  }

  function bindEvents() {
    $('#userSelect')
      .on('select2:select', function(e) {
        const uid = e.params.data.id;
        console.log('Đã chọn NV:', uid);
        const filtered = customerList.filter(c => cskhMapping[c.id_customer] == uid);
        renderCustomerOptions(filtered);
      })
      .on('select2:unselect', function() {
        console.log('Bỏ chọn NV, trả về full list');
        renderCustomerOptions(customerList);
      });

    $('#customerSelect').on('select2:select', function(e) {
      const cid = e.params.data.id;
      console.log('Đã chọn KH:', cid);
      const assignedUser = cskhMapping[cid] || null;
      $('#userSelect').val(assignedUser).trigger('change.select2');
    });
  }
}



  $(document).on("click", ".view-order", function () {
    Swal.fire({ title: 'Đang load...', didOpen: () => { Swal.showLoading(); } });
    const id_order = $(this).data("id");
    $.ajax({
      url: "https://khaituanminh.atwebpages.com/api/get_ordersinfo.php",
      method: "POST",
      contentType: "application/json",
      dataType: "json",
      data: JSON.stringify({ id_order }),
      success: function (res) {
        if (res.status === "success") {
          const data = res.data;
          $("#detailCustomer").text(data.customer_name);
          $("#detailUser").text(data.user_name);
          $("#detailDate").text(data.date);
          $("#detailTotal").text(data.total.toLocaleString('vi-VN'));
          const tbody = $("#orderProducts");
          tbody.empty();
          data.detail.forEach(item => {
            tbody.append(`<tr><td>${item.name}</td><td>${item.amount}</td></tr>`);
          });
          Swal.close();
          new bootstrap.Modal(document.getElementById("orderDetailModal")).show();
        } else {
          Swal.fire("Lỗi", res.message, "error");
        }
      },
      error: function () {
        Swal.fire("Lỗi", "Không thể tải chi tiết đơn hàng", "error");
      }
      
    });
  });
  
  function fetchProductsForSelect() {
  $.ajax({
    url: "https://khaituanminh.atwebpages.com/api/get_allproduct.php",
    method: "POST",
    contentType: "application/json",
    data: JSON.stringify({ id_business }),
    success: function (res) {
      if (res.status === "success") {
        productList =res.data;
        const tbody = $("#productTable tbody");
        tbody.empty();
        res.data.forEach(product => {
          const row = `
            <tr class="product-item" data-price="${product.price}">
              <td><input type="checkbox" class="form-check-input product-check" data-id="${product.id_product}" data-name="${product.name}" data-price="${product.price}"></td>
              <td>${product.name}</td>
              <td>${Number(product.price).toLocaleString('vi-VN')} đ</td>
              <td><input type="number" class="form-control quantity-input" min="1" value="1" disabled></td>
              <td id="producttotalprice"></td>
            </tr>
          `;
          tbody.append(row);
        });
        if (!$.fn.DataTable.isDataTable("#productTable")) {
          $("#productTable").DataTable({
            pageLength: 10
          });
        }
        handleProductSelection(); 
      }
    }
  });
}


$("#confirmProductSelection").click(function () {
  const selectedProducts = [];
  const productListHtml = [];

  const table = $("#productTable").DataTable();
  const allData = table.rows({ search: 'applied' }).data(); 

  allData.each(function (rowData, index) {
    const checkbox = $(table.row(index).node()).find('.product-check');
    if (checkbox.is(":checked")) {
      const id_product = checkbox.data("id");
      const name = checkbox.data("name");
      const quantity = $(table.row(index).node()).find(".quantity-input").val();
      const price = $(table.row(index).node()).data("price");
      // const productprice = $(table.row(index).node()).data("producttotalprice");
      const productprice = $(table.row(index).node()).find("#producttotalprice").text();


      selectedProducts.push({ id_product, name, amount: quantity, price });
      productListHtml.push(`<div>${name} - SL: ${quantity} - Giá: ${productprice}`);
    }
  });

  // Cập nhật giao diện
  $("#productList").html(productListHtml.join(""));
  window.selectedProducts = selectedProducts;

  const total = selectedProducts.reduce((acc, item) => acc + (item.price * item.amount), 0);
  $("#totalAmountInput").val(total.toLocaleString('vi-VN'));

  const productModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("selectProductModal"));
  productModal.hide();
});



  function handleProductSelection() {
    $(document).off("change", ".product-check").on("change", ".product-check", function () {
      const row = $(this).closest(".product-item");
      row.find(".quantity-input").prop("disabled", !this.checked);
      calculateTotal();
   
    });
    $(document).off("input", ".quantity-input").on("input", ".quantity-input", function () {
      calculateTotal();

    });
  }
  // Tính tổng tiền
$('#productSelect, #quantityInput').change(function() {
  const price = $('#productSelect').find(':selected').data('price');
  const quantity = $('#quantityInput').val();
  const totalPrice = price * quantity;
  $('#totalPriceInput').val(totalPrice.toLocaleString('vi-VN') + ' đ');
});

function calculateTotal() {
  let total = 0;
  $(".product-item").each(function () {
    const checkbox = $(this).find(".product-check");
    const quantity = parseInt($(this).find(".quantity-input").val()) || 0;
    const price = parseInt($(this).data("price")) || 0;
    if (checkbox.is(":checked")) {
      const productTotal = price * quantity; 
     
      $(this).find("#producttotalprice").text(productTotal.toLocaleString('vi-VN') + ' đ'); // Cập nhật vào ô tổng giá của sản phẩm
      total += productTotal;
    }
  });

  $("#totalAmountInput").val(total.toLocaleString('vi-VN') + ' đ');
}


  $("#createOrderForm").submit(function (e) {
  Swal.fire({ title: 'Đang load...', didOpen: () => { Swal.showLoading(); } });

  e.preventDefault();
  const selectedProducts = window.selectedProducts || [];
  if (selectedProducts.length === 0) {
    Swal.fire("Chú ý", "Vui lòng chọn ít nhất một sản phẩm", "warning");
    return;
  }
  const formData = Object.fromEntries(new FormData(this).entries());
  formData.id_business = id_business;
  $.ajax({
    url: "https://khaituanminh.atwebpages.com/api/create_orders.php",
    method: "POST",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify(formData),
    success: function (res) {
      if (res.status === "success" && res.data.id_order) {
        const id_order = res.data.id_order;
        const detailCalls = selectedProducts.map(p => {
          const detailData = {
            id_order,
            id_product: p.id_product,
            amount: p.amount,
            id_business
          };
          return $.ajax({
            url: "https://khaituanminh.atwebpages.com/api/add_detailorder.php",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify(detailData)
          });
        });

        Promise.all(detailCalls).then(() => {
          bootstrap.Modal.getInstance(document.getElementById('addOrderModal')).hide();
          fetchOrders();
          Swal.fire("Thành công", "Đơn hàng đã được thêm", "success");
        });
      } else {
        Swal.fire("Lỗi", res.message || "Không thể tạo đơn hàng", "error");
      }
    },
    error: function () {
      Swal.fire("Lỗi", "Không thể kết nối máy chủ", "error");
    }
  });
});


$(document).on('click', '.print-order', function() {
  const id_order = $(this).data('id');
  Swal.fire({ title: 'Đang tải...', didOpen: () => Swal.showLoading() });
  
  $.ajax({
    url: "https://khaituanminh.atwebpages.com/api/get_ordersinfo.php",
    method: "POST",
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify({ id_order }),
    success: function(res) {
      Swal.close();
      if (res.status === "success") {
        const d = res.data;
        // Xây dựng HTML cho in
let html = `
<div style="display: flex; justify-content: center; font-family: Arial, sans-serif; padding-left: 80px">
  <div style="width: 600px; padding: 20px; background: #fff;">
    <h2 style="text-align: center; margin-bottom: 20px;">HÓA ĐƠN BÁN HÀNG</h2>
    <p><strong>Đơn hàng:</strong> ${id_order}</p>
    
    <p><strong>Ngày:</strong> ${d.date}</p>
    <p><strong>Khách hàng:</strong> ${d.customer_name}</p>
    <p><strong>Người tạo đơn:</strong> ${d.user_name}</p>
    <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
      <thead>
        <tr>
          <th style="border: 1px solid #ddd; padding: 8px;">Sản phẩm</th>
          <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Số lượng</th>
        </tr>
      </thead>
      <tbody>
${d.detail.map(item => `
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px;">${item.name}</td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${parseInt(item.amount, 10)}</td>
        </tr>`).join('')}
      </tbody>
      <tfoot>
        <tr>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: left;"><strong>Tổng cộng</strong></td>
          <td style="border: 1px solid #ddd; padding: 8px; text-align: right;"><strong>${Number(d.total).toLocaleString('vi-VN')} đ</strong></td>
        </tr>
      </tfoot>
    </table>
    <div style="text-align: right; margin-top: 30px;">
      <p>Người lập hóa đơn</p>
      <p style="font-size: small;">(Ký và ghi rõ họ tên)</p>
    </div>
  </div>
</div>`;


        $('#printSection').html(html).show();
        $('#printSection').print({
          globalStyles   : true,
          mediaPrint     : false,
          noPrintSelector: ".no-print",
          iframe         : true
        });
        $('#printSection').hide();
      } else {
        Swal.fire("Lỗi", res.message, "error");
      }
    },
    error: function() {
      Swal.fire("Lỗi", "Không thể tải chi tiết đơn hàng", "error");
    }
  });
});



  $(document).ready(function () {
    fetchOrders();
    $("#addOrderModal").on("shown.bs.modal", function () {
      fetchProductsForSelect();
      loadDropdownData();
    });

    $("#openProductModal").click(function () {
  const modal = new bootstrap.Modal(document.getElementById("selectProductModal"));
    modal.show();
    });

    $('#addOrderModal').on('hidden.bs.modal', function () {
    $("#createOrderForm")[0].reset();
    $("#customerSelect").val("").trigger("change");
    $("#userSelect").val("").trigger("change");
    window.selectedProducts = [];
    $("#productList").html("");
    $("#totalAmountInput").val(0);
    $("#productTable").DataTable().clear().destroy();
    });

    });
  
  $('#importExcelBtn').click(function () {
  const file = document.getElementById('excelFileInput').files[0];
  if (!file) return Swal.fire('Lỗi', 'Vui lòng chọn file Excel', 'error');
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    const header = jsonData[0];
    const rows = jsonData.slice(1);
    let groupedOrders = [];
    let currentOrder = null;

    rows.forEach(row => {
      const [maKH, tenKH, maNV ,tenNV, ngay, tenSP, sl] = row;

      if (maKH || tenKH || maNV ||  tenNV || ngay) {
        if (currentOrder) groupedOrders.push(currentOrder);
        currentOrder = {
          ma_kh: maKH,
          ten_kh: tenKH,
          ma_nv: maNV,
          ten_nv: tenNV,
          date: ngay,
          total: 0,
          products: []
        };
      }

      if (tenSP && sl) {
        const product = {
          name: tenSP,
          amount: parseInt(sl),
        };
        currentOrder.products.push(product);
      }
    });

    if (currentOrder) groupedOrders.push(currentOrder);
    let success = 0, fail = 0;
    function sendNext(i) {
  if (i >= groupedOrders.length) {
    return Swal.fire('Hoàn tất', `Đã thêm ${success} đơn hàng. Thất bại: ${fail}`, 'info').then(() => {
      fetchOrders();
    });
  }
  const order = groupedOrders[i];
  const createOrderData = {
    id_business,
    id_customer: order.ma_kh || '',
    id_user: order.ma_nv || '',
    date: order.date,
    total: order.total
  };
  $.ajax({
    url: 'https://khaituanminh.atwebpages.com/api/create_orders.php',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(createOrderData),
    success: function (res) {
      if (res.status === 'success' && res.data.id_order) {
        const id_order = res.data.id_order;
        const detailCalls = order.products.map(p => {
          const matchedProduct = productList.find(pr => pr.name.trim().toLowerCase() === p.name.trim().toLowerCase());
          return $.ajax({
            url: 'https://khaituanminh.atwebpages.com/api/add_detailorder.php',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
              id_order,
              id_product: matchedProduct?.id_product || '',
              amount: p.amount,
              id_business
            })
          });
        });

        Promise.all(detailCalls).then(() => {
          success++;
          sendNext(i + 1);
        }).catch(() => {
          fail++;
          sendNext(i + 1);
        });
      } else {
        fail++;
        sendNext(i + 1);
      }
    },
    error: function () {
      fail++;
      sendNext(i + 1);
    }
  });
}

    sendNext(0);
  };

  reader.readAsArrayBuffer(file);
});

// xuất excel
$('#exportExcelBtn').click(function () {
  $.ajax({
    url: "https://khaituanminh.atwebpages.com/api/get_allorderbusiness.php",
    method: "POST",
    contentType: "application/json",
    data: JSON.stringify({ id_business }),
    success: function (res) {
      if (res.status === "success") {
        const orders = res.data.orders;
        const header = ['Mã đơn hàng', 'Khách hàng', 'Nhân viên', 'Ngày tạo', 'Tổng tiền', 'Sản phẩm'];

        const data = [];
        const promises = orders.map(order => {
          return $.ajax({
            url: "https://khaituanminh.atwebpages.com/api/get_ordersinfo.php",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ id_order: order.id_order })
          }).then(orderDetail => {
            const productsText = orderDetail.data.detail
              .map(p => `${p.name} (${p.amount})`)
              .join(', ');

            const formattedTotal = Number(order.total).toLocaleString('vi-VN');

            data.push([
              order.id_order,
              order.customer_name,
              order.user_name,
              order.date,
              formattedTotal + " đ",
              productsText
            ]);
          });
        });

        Promise.all(promises).then(() => {
          const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'DanhSachDonHang');

          const now = new Date();
          const dd = String(now.getDate()).padStart(2, '0');
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const yy = String(now.getFullYear());
          const formattedDate = `${dd}-${mm}-${yy}`;

          XLSX.writeFile(wb, `DanhSachDonHang_${formattedDate}.xlsx`);

        });
      } else {
        Swal.fire("Lỗi", res.message, "error");
      }
    }
  });
});


</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<div id="printSection" style="display: none;"></div>

</body>
</html>
