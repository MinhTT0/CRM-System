<!DOCTYPE html>
<html lang="en">
<head>
        
    <meta charset="UTF-8">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   
    <script src="logout.js"></script>  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>Trang chủ Dashboard</title>

</head>
<body>
<div class="sidebar bg-dark text-white">
  <h2 class="text-center py-3">CRM System</h2>
  <a href="index.html" class="nav-link px-3 active bg-primary text-white" data-feature="Báo cáo"> <i class="bi bi-house-door me-2"></i>Trang chủ</a>

  <a class="nav-link px-3  " data-bs-toggle="collapse" data-feature="Quản lý khách hàng" href="#customerMenu" >
    <i class="bi bi-people me-2"></i>Khách Hàng <i class="bi bi-caret-down-fill float-end"></i>
  </a>
  <div class="collapse" id="customerMenu">
    <a href="customers.html">Thông tin khách hàng</a>
    <a href="cskh.html">Chăm sóc khách hàng</a>
    <a href="customerstype.html">Loại khách hàng</a>
    <a href="more.html">Dữ liệu tuỳ chỉnh</a>
  </div>
  <a href="user.html" class="nav-link px-3" id="nav-manager" ><i class="bi bi-person-workspace me-2"></i>Nhân Viên</a>
  <a href="orders.html" class="nav-link px-3"  id="nav-order"><i class="bi bi-bag-check me-2"></i>Đơn Hàng</a>
  <a class="nav-link px-3" id="nav-product" data-bs-toggle="collapse" href="#productMenu" >
  <i class="bi bi-box-seam me-2" ></i>Sản Phẩm <i class="bi bi-caret-down-fill float-end"></i>
  </a>
      <div class="collapse" id="productMenu">
      <a href="products.html">Thông tin sản phẩm</a>
      <a href="measurement.html">Loại đơn vị tính</a>
      </div>
  <a href="work.html" class="nav-link px-3"  id="nav-work"><i class="bi bi-list-task me-2"></i>Công việc</a> 
  <a href="apointment.html" class="nav-link px-3 " id="nav-apointment"><i class="bi bi-calendar-check"></i> Lịch hẹn</a>   
   <div class="mt-auto">
      <a  id="returnBtn" class="nav-link px-3 outline" href="ADMIN/business.html">
        <button class="btn btn-outline-danger mb-3 ms-2"><i class="bi bi-box-arrow-right me-2"></i>ADMIN WEB</button>
      </a>
    </div>
</div>  

<div class="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>Dashboard</h2>
      <div class="d-flex align-items-center gap-3">
        <div class="dropdown" data-bs-auto-close="outside">
          <a class="btn btn-light position-relative"
             href="#"
             id="notifDropdown"
             data-bs-toggle="dropdown"
             aria-expanded="false"
             ata-bs-auto-close="outside">
            <i class="bi bi-bell fs-4"></i>
            <span id="notifBadge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
              0
            </span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end p-2"
              aria-labelledby="notifDropdown"
              style="max-width:300px; max-height:400px; overflow:auto;">
            <li class="text-center text-muted small">Đang tải...</li>
          </ul>
        </div>
        
  
        <!-- user dropdown -->
        <div class="dropdown">
          <a id="userNameDisplay"
             class="btn btn-light dropdown-toggle"
             href="#"
             role="button"
             data-bs-toggle="dropdown"
             aria-expanded="false">
            <i class="bi bi-person-circle text-primary"></i> Tài khoản
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="profile.html">Thông tin tài khoản</a></li>
            <li><a class="dropdown-item" href="pass.html">Đổi mật khẩu</a></li>
            <li id="logoutBtn">
              <a class="dropdown-item" href="#">
                <i class="bi bi-box-arrow-right"></i> Đăng xuất
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <hr>
    
      <div class="row g-4 mb-4">
        <!-- Tổng số khách hàng -->
        <div class="col-sm-3 col-lg-3 flex-fill">
          <div class="card text-white position-relative bg-warning stat-card h-80">
            <i class="bi bi-people-fill stat-icon"></i>
            <div class="card-body">
              <h3 class="stat-number stat-customers">0</h3>
              <p class="stat-title">Tổng số khách hàng</p>
            </div>
            <div class="card-footer bg-transparent border-0 text-end">
              <a href="#" class="text-white text-decoration-none">
                <a href="customers.html">Tông tin Thêm</a> <i class="bi bi-arrow-right-circle"></i>
              </a>
            </div>
          </div>
        </div>
       
        <!-- Công việc hoàn thành
        <div class="col-sm-6 col-lg-4">
          <div class="card text-white position-relative bg-primary stat-card h-100">
            <i class="bi bi-check2-circle stat-icon"></i>
            <div class="card-body">
              <h3 class="stat-number stat-completed">đ0</h3>
              <p class="stat-title">Công việc hoàn thành</p>
            </div>
            <div class="card-footer bg-transparent border-0 text-end">
              <a href="#" class="text-white text-decoration-none">
                <a href="work.html">Tông tin Thêm</a> <i class="bi bi-arrow-right-circle"></i>
              </a>
            </div>
          </div>
        </div> -->
      
        <!-- Nhân viên -->
        <div class="col-sm-3 col-lg-3 flex-fill">
          <div class="card text-white position-relative bg-info stat-card h-100">
            <i class="bi bi-person-badge stat-icon"></i>
            <div class="card-body">
              <h3 class="stat-number stat-employees">0</h3>
              <p class="stat-title">Nhân viên</p>
            </div>
            <div class="card-footer bg-transparent border-0 text-end">
              <a href="#" class="text-white text-decoration-none">
                <a href="user.html">Tông tin Thêm</a> <i class="bi bi-arrow-right-circle"></i>
              </a>
            </div>
          </div>
        </div>
           <!-- Tổng số đơn hàng -->
           <div class="col-sm-3 col-lg-3 " id="ordercard">
            <div class="card text-white position-relative bg-success stat-card h-80">
              <i class="bi bi-cart-fill stat-icon"></i>
              <div class="card-body">
                <h3 class="stat-number stat-orders">0</h3>
                <p class="stat-title">Tổng số đơn hàng</p>
              </div>
              <div class="card-footer bg-transparent border-0 text-end">
                <a href="#" class="text-white text-decoration-none">
                  <a href="orders.html">Tông tin Thêm</a> <i class="bi bi-arrow-right-circle"></i>
                </a>
              </div>
            </div>
          </div>
        
         <!-- Doanh thu -->
         <div class="col-sm-3 col-lg-3" id="revenuecard">
          <div class="card text-white position-relative bg-danger stat-card h-100">
            <i class="bi bi-currency-dollar stat-icon"></i>
            <div class="card-body">
              <h3 class="stat-number stat-revenue">₫0</h3>
              <p class="stat-title" style="font-size:30px;font-weight: 500">Doanh thu</p>
            </div>
            <div class="card-footer bg-transparent border-0 text-end">
              <!-- <a href="#" class="text-white text-decoration-none">
                Thông tin Thêm <i class="bi bi-arrow-right-circle"></i>
              </a> -->
            </div>
          </div>
        </div>
      </div>
      
<!-- Phần chọn kiểu thống kê và lọc dữ liệu -->
<div class="d-flex flex-wrap align-items-center gap-3 mb-3">
  <label>Kiểu thống kê:</label>
  <select id="statType" class="form-select w-auto">
    <option value="month">Theo năm</option>
    <option value="year">Theo từng năm</option>
    <option value="date">Theo ngày</option>
  </select>

  <!-- Chọn năm khi thống kê theo tháng -->
  <div id="monthPickerWrapper" class="d-flex align-items-center gap-2">
    <label for="monthPicker" class="mb-0">Chọn năm:</label>
    <input type="number" id="monthPicker" class="form-control w-auto" min="2000" max="2100" value="2024">
  </div>

  <!-- Khoảng năm khi thống kê theo năm -->
  <div id="yearRangeWrapper" class="d-none d-flex align-items-center gap-2">
    <label for="startYear" class="mb-0">Từ năm:</label>
    <input type="number" id="startYear" class="form-control w-auto" value="2020" min="2000" max="2100">
    <label for="endYear" class="mb-0">Đến năm:</label>
    <input type="number" id="endYear" class="form-control w-auto" value="2025" min="2000" max="2100">
  </div>

  <!-- Khoảng ngày khi thống kê theo ngày -->
  <div id="dateRangeWrapper" class="d-none d-flex align-items-center gap-2">
    <label for="startDate" class="mb-0">Từ ngày:</label>
    <input type="date" id="startDate" class="form-control w-auto">
    <label for="endDate" class="mb-0">Đến ngày:</label>
    <input type="date" id="endDate" class="form-control w-auto">
  </div>

  <!-- Chọn nhân viên để lọc dữ liệu -->
  <div id="userWrapper" class="d-flex align-items-center gap-2">
    <label for="userPicker" class="mb-0">Nhân viên:</label>
    <select id="userPicker" class="form-select w-auto">
      <option value="">Tất cả nhân viên</option>
    </select>
  </div>

  <button id="applyFilterBtn" class="btn btn-primary">Lọc dữ liệu</button>
  <button id="exportExcelBtn" class="btn btn-outline-success"><i class="bi bi-file-earmark-spreadsheet"></i> Xuất Excel</button>
  <button id="exportPdfBtn" class="btn btn-outline-secondary"><i class="bi bi-printer"></i></i> In</button>
</div>
   <!-- === Phần Chart và Metrics === -->
<div class="row g-4 mb-4">
  <!-- Chart 1: Doanh thu -->
  <div class="col-md-6" id="revenueChartCard">
    <div class="card h-100">
      <div class="card-body">
        <h5 class="card-title">Biểu đồ Doanh thu</h5>
        <canvas id="revenueChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart 2 + Metrics -->
  <div class="col-md-6 d-flex flex-column">
    <div class="d-flex gap-3">
      <div class="card flex-fill" id="mostCustomerCard">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2">Khách hàng mua nhiều nhất</h6>
          <p id="mostCustomer" class="display text-success">--</p>
        </div>
      </div>
      <div class="card flex-fill" id="mostProductCard">
        <div class="card-body text-center">
          <h6 class="card-subtitle mb-2">Sản phẩm bán chạy nhất</h6>
          <p id="mostProduct" class="display text-primary">--</p>
        </div>
      </div>
    </div>
    <br>
    <!-- Biểu đồ khách hàng -->
    <div class="card mb-3 flex-fill">
      <div class="card-body">
        <h5 class="card-title">Biểu đồ Số lượng khách hàng</h5>
        <canvas id="customerChart"></canvas>
      </div>
    </div>
    <!-- Metrics dưới chart -->
  
  </div>
</div>

</div>

<!-- Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.print/1.6.2/jQuery.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="notification.js"></script>
<script>
const id_businesstype = localStorage.getItem("id_businesstype");

  let revenueData = [];
let customerData = [];
let chartRevenue = null;
let chartCustomer = null;

  const id_business = localStorage.getItem("id_business");

  // // Tạo biểu đồ
  // function updateChart(dataArr, title) {
  //   const labels = dataArr.map(item => item.label);
  //   const values = dataArr.map(item => item.total);
  //   if (chartInstance) chartInstance.destroy();
  //   const ctx = document.getElementById('revenueChart').getContext('2d');
    
  //   chartInstance = new Chart(ctx, {
  //     type: 'bar',
  //     data: {
  //       labels: labels,
  //       datasets: [{
  //         label: title || 'Doanh thu',
  //         data: values,
  //         backgroundColor: 'rgba(75, 192, 192, 0.7)'
  //       }]
  //     },
  //     options: {
  //       responsive: true,
  //       scales: { y: { beginAtZero: true } },
  //       // borderColor	: 'rgba(0, 0, 255, 0.1)'

  //     }
  //   });
  // }

  // Load danh sách nhân viên vào dropdown
  function loadUsers() {
    $.ajax({
      url: 'https://khaituanminh.atwebpages.com/api/get_alluser.php',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ id_business }),
      dataType: 'json',
      success(res) {
        if (res.status === 'success') {
          $('#userPicker').append(
            res.data.map(u => `<option value="${u.id_user}">${u.name} [${u.id_user}]</option>`).join('')
          );
        }
      }
    });
  }



  function updateChart(canvasId, chartVar, dataArr, title, chartType, color) {
  // hủy chart cũ nếu có
  if (window[chartVar]) window[chartVar].destroy();

  const ctx = document.getElementById(canvasId).getContext('2d');
  window[chartVar] = new Chart(ctx, {
    type: chartType,      // 'bar' hoặc 'line'
    data: {
      labels: dataArr.map(x => x.label),
      datasets: [{
        label: title,
        data: dataArr.map(x => x.total),
        // với bar thì dùng backgroundColor, với line thì dùng borderColor
        backgroundColor: chartType === 'bar'  ? color : undefined,
        borderColor:     chartType === 'line' ? color : undefined,
        fill:            chartType === 'line' ? false : undefined
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}


function fetchRevenueByMonth(year, userId = null) {
  Swal.fire({ title: 'Đang load...', didOpen: () => { Swal.showLoading(); } });
  const now       = new Date();
  const currentY  = now.getFullYear();
  const currentM  = now.getMonth() + 1;
  const lastMonth = (year === currentY) ? currentM : 12;
  const monthsCnt = lastMonth;

   revenueData  = Array.from({length: monthsCnt}, (_, i) => ({ label:`T ${i+1}`, total:0 }));
   customerData = Array.from({length: monthsCnt}, (_, i) => ({ label:`T ${i+1}`, total:0 }));
  let cnt = 0;
  let summary = { revenue:0, orders:0, customers:0, employees:0 };
  let topCustomer = null, topProduct = null;
  let lastCustCount = 0, lastEmpCount = 0;

  for (let m = 1; m <= lastMonth; m++) {
    $.ajax({
      url: userId
        ? 'https://khaituanminh.atwebpages.com/api/get_statisticuser.php'
        : 'https://khaituanminh.atwebpages.com/api/get_statistic.php',
      method: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify({ year, month: m, id_business, ...(userId && { id_user: userId }) }),
      success(res) {
        const d = res.data || {};

        // 1) Doanh thu & đơn hàng
        const rev = d[`total in ${m}/${year}`] || 0;
        revenueData[m-1].total = rev;
        summary.revenue += rev;
        summary.orders  += d[`total orders in ${m}/${year}`] || 0;

        // 2) Khách mới – lưu tạm nếu là tháng cuối
        const custKey = userId
        ? 'total customer cskh'
        : `total customer till ${m}/${year}`;
      const custCount = userId
        ? (d[custKey]?.num || 0)
        : (d[custKey]?.count || 0);
        customerData[m-1].total = custCount;
        if (m === lastMonth) {
          lastCustCount = custCount;
        }

        // 3) Nhân viên – lưu tạm nếu là tháng cuối
        const empCount = d[`total user`]?.count || summary.employees;
        if (m === lastMonth) {
          lastEmpCount = empCount;
        }

        // 4) Top buyer / seller (theo cả năm)
        if (d[`most buy in ${year}`]?.[0])   topCustomer = d[`most buy in ${year}`][0];
        if (d[`most sell in ${year}`]?.[0])  topProduct  = d[`most sell in ${year}`][0];
      },
      complete() {
        if (++cnt === monthsCnt) {
          // Sau khi tất cả request xong mới cập nhật UI:
          summary.customers = lastCustCount;
          summary.employees = lastEmpCount;

          // — Cập nhật số liệu tổng quát —
          $('.stat-revenue'  ).text(summary.revenue.toLocaleString('vi-VN') + ' đ');
          $('.stat-orders'   ).text(summary.orders + ' đơn');
          $('.stat-customers').text(summary.customers + ' khách');
          $('.stat-employees').text(summary.employees + ' nhân viên');
          if(topCustomer.name == null)
          {
            $('#mostCustomer').text(`--`);
          }
          else{ $('#mostCustomer').text(topCustomer ? `${topCustomer.name} (${topCustomer['total orders']} đơn)` : '--');}
          if(topProduct.name == null)
          {
            $('#mostProduct').text(`--`);
          }
          else
          {
            $('#mostProduct' ).text(
            topProduct  ? `${topProduct.name} (${topProduct['total sell']} sản phẩm)` : '--'
          );

          }
         
          // — Vẽ 2 biểu đồ —
          updateChart(
            'revenueChart', 'chartRevenue',
            revenueData, `Doanh thu ${year}`, 'bar',   'rgba(75,192,192,0.7)'
          );
          updateChart(
            'customerChart','chartCustomer',
            customerData, `Khách mới ${year}`,  'line', 'rgba(54,162,235,0.8)'
          );
          Swal.close();

        }
      }
    });
  }

}



// Thống kê theo năm (fix race-condition)
async function fetchRevenueByYear(startYear, endYear, userId = null) {
  Swal.fire({ title: 'Đang load...', didOpen: () => { Swal.showLoading(); } });
  const years = Array.from(
    { length: endYear - startYear + 1 },
    (_, i) => startYear + i
  );

  // Khởi tạo data cho 2 biểu đồ
   revenueData  = years.map(y => ({ label: String(y), total: 0 }));
   customerData = years.map(y => ({ label: String(y), total: 0 }));

  // Các biến tổng hợp
  const summary = { revenue: 0, orders: 0, customers: 0, employees: 0 };
  let lastCustCount = 0, lastEmpCount = 0;
  let topCustomer = null, topProduct = null;

  const url = userId
    ? 'https://khaituanminh.atwebpages.com/api/get_statisticuser.php'
    : 'https://khaituanminh.atwebpages.com/api/get_statistic.php';

  // Tạo mảng promise
  const requests = years.map((year, idx) => {
    return $.ajax({
      url,
      method: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify({
        year,
        id_business,
        ...(userId && { id_user: userId })
      })
    }).then(res => {
      const d = res.data || {};

      // 1) Doanh thu & đơn hàng
      const revKey = `total in ${year}`;
      const ordKey = `total orders in ${year}`;
      const rev = d[revKey] || 0;
      revenueData[idx].total = rev;
      summary.revenue += rev;
      summary.orders  += d[ordKey] || 0;

      // 2) Khách mới
      const custKey = userId
        ? 'total customer cskh'
        : `total customer till ${year}`;
      const custCount = userId
        ? (d[custKey]?.num || 0)
        : (d[custKey]?.count || 0);
      customerData[idx].total = custCount;

      // 3) Nhân viên
      const empCount = d['total user']?.count || 0;

      // 4) Top buyer & seller
      const buyer = d[`most buy in ${year}`]?.[0]  || null;
      const seller = d[`most sell in ${year}`]?.[0] || null;

      // --- CHỈ LƯU TẠM CHO NĂM CUỐI ---
      if (year === endYear) {
        lastCustCount = custCount;
        lastEmpCount  = empCount;
        if (buyer)  topCustomer = buyer;
        if (seller) topProduct  = seller;
      }
    });
  });

  // Đợi xong tất cả request
  await Promise.all(requests);

  // Gán vào summary sau khi chắc chắn đã có dữ liệu của endYear
  summary.customers = lastCustCount;
  summary.employees = lastEmpCount;

  // 5) Cập nhật các card số liệu
  $('.stat-revenue'  ).text(summary.revenue.toLocaleString('vi-VN') + ' đ');
  $('.stat-orders'   ).text(summary.orders           + ' đơn');
  $('.stat-customers').text(summary.customers        + ' khách');
  $('.stat-employees').text(summary.employees        + ' nhân viên');
  $('#mostCustomer').text(
    topCustomer ? `${topCustomer.name} (${topCustomer['total orders']} đơn)` : '--'
  );
  $('#mostProduct' ).text(
    topProduct  ? `${topProduct.name}  (${topProduct['total sell']} sản phẩm)` : '--'
  );

  // 6) Vẽ lại 2 biểu đồ
  updateChart(
    'revenueChart',
    'chartRevenue',
    revenueData,
    `Doanh thu ${startYear}-${endYear}${userId?' (NV)':''}`,
    'bar',
    'rgba(75,192,192,0.7)'
  );
  updateChart(
    'customerChart',
    'chartCustomer',
    customerData,
    `Khách mới ${startYear}-${endYear}${userId?' (NV)':''}`,
    'line',
    'rgba(54,162,235,0.8)'
  );
  Swal.close();

}



// Thống kê theo ngày (fix race-condition)
function fetchRevenueByDate(startDt, endDt, userId = null) {
  Swal.fire({ title: 'Đang load...', didOpen: () => { Swal.showLoading(); } });
  // 1. Khởi tạo mảng ngày
  const start = new Date(startDt), end = new Date(endDt);
  revenueData = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const label = d.toISOString().split('T')[0];
    revenueData.push({ label, total: 0 });
  }

  // 2. Biến đếm và summary
  let completed = 0;
  const summary = { revenue: 0, orders: 0, customers: 0, employees: 0 };
  let topCustomer = null, topProduct = null;
  let maxOrders = 0, maxSells = 0;
  // biến tạm cho ngày cuối
  let lastCustCount = 0, lastEmpCount = 0;

  // 3. Loop gọi API
  revenueData.forEach(item => {
    $.ajax({
      url: userId
        ? 'https://khaituanminh.atwebpages.com/api/get_statisticdateuser.php'
        : 'https://khaituanminh.atwebpages.com/api/get_statisticdate.php',
      method: 'POST',
      contentType: 'application/json',
      dataType: 'json',
      data: JSON.stringify({
        id_business,
        date: item.label,
        ...(userId && { id_user: userId })
      }),
      success(res) {
        if (res.status !== 'success') return;
        const d = res.data;

        // a) Doanh thu & tổng đơn
        const rev = d[`total in ${item.label}`] || 0;
        const ord = d[`total orders in ${item.label}`] || 0;
        item.total = rev;
        summary.revenue += rev;
        summary.orders  += ord;

        // b) Lưu tạm khách & nhân viên nếu là ngày cuối
        const custCount = d[`total customer till ${item.label}`]?.count || 0;
        const empCount  = d[`total user`]?.count || 0;
        if (item.label === endDt) {
          lastCustCount = custCount;
          lastEmpCount  = empCount;
        }

        // c) Top buyer theo số đơn
        const mb = d[`most buy in ${item.label}`];
        if (Array.isArray(mb) && mb[0]) {
          const cnt = mb[0]['total orders'] || 0;
          if (cnt > maxOrders) {
            maxOrders = cnt;
            topCustomer = mb[0];
          }
        }

        // d) Top product theo số bán
        const ms = d[`most sell in ${item.label}`];
        if (Array.isArray(ms) && ms[0]) {
          const sells = ms[0]['total sell'] || 0;
          if (sells > maxSells) {
            maxSells = sells;
            topProduct = ms[0];
          }
        }
      },
      complete() {
        // 4. Khi đã gọi xong hết
        if (++completed === revenueData.length) {
          // 5. Gán khách & nhân viên của ngày cuối
          summary.customers = lastCustCount;
          summary.employees = lastEmpCount;

          // 6. Vẽ chart
          updateChart(
            'revenueChart', 'chartRevenue',
            revenueData,
            `Doanh thu ${startDt} → ${endDt}${userId?' (NV)':''}`,
            'bar', 'rgba(75,192,192,0.7)'
          );

          // 7. Cập nhật các card
          $('.stat-revenue'  ).text(summary.revenue.toLocaleString('vi-VN') + ' đ');
          $('.stat-orders'   ).text(summary.orders + ' đơn');
          $('.stat-customers').text(summary.customers + ' khách');
          $('.stat-employees').text(summary.employees + ' nhân viên');

          // 8. Top buyer/product
          $('#mostCustomer').text(
            topCustomer ? `${topCustomer.name} (${topCustomer['total orders']} đơn)` : '--'
          );
          $('#mostProduct' ).text(
            topProduct ? `${topProduct.name} (${topProduct['total sell']} sản phẩm)` : '--'
          );
          Swal.close();
        }
      }
    });
  });
}


  // Xử lý sự kiện thay đổi loại thống kê
  $('#statType').on('change', function() {
    const type = $(this).val();
    $('#monthPickerWrapper, #yearRangeWrapper, #dateRangeWrapper').addClass('d-none');
    if (type === 'month') $('#monthPickerWrapper').removeClass('d-none');
    if (type === 'year') $('#yearRangeWrapper').removeClass('d-none');
    if (type === 'date') $('#dateRangeWrapper').removeClass('d-none');
    $('#userWrapper').removeClass('d-none');
  });

  // Xử lý nút Lọc
  $('#applyFilterBtn').click(function() {
    const type = $('#statType').val();
    const userId = $('#userPicker').val() || null;

    if (type === 'month') {
      const year = parseInt($('#monthPicker').val());
      fetchRevenueByMonth(year, userId);
    } else if (type === 'year') {
      const startYear = parseInt($('#startYear').val());
      const endYear = parseInt($('#endYear').val());
      if (startYear > endYear) return Swal.fire('Lỗi', 'Năm bắt đầu phải ≤ năm kết thúc', 'error');
      fetchRevenueByYear(startYear, endYear, userId);
    } else if (type === 'date') {
      const startDate = $('#startDate').val();
      const endDate = $('#endDate').val();
      if (!startDate || !endDate || startDate > endDate) return Swal.fire('Lỗi', 'Khoảng ngày không hợp lệ', 'error');
      fetchRevenueByDate(startDate, endDate, userId);
    }
  });

// Hàm xuất Excel (kèm biểu đồ)
async function exportExcel() {
  const workbook = new ExcelJS.Workbook();
  const busType = Number(id_businesstype || 0);

  // === Sheet 1: Dữ liệu doanh thu ===
  if (busType == "3") {
  const dataSheet = workbook.addWorksheet('Doanh thu');
  dataSheet.columns = [
    { header: 'Thời gian', key: 'label', width: 20 },
    { header: 'Tổng',       key: 'total', width: 20 }
  ];
  // ghi data vào sheet
  revenueData.forEach(r => dataSheet.addRow({ label: r.label, total: r.total }));
  }
    // === Sheet 1: Dữ liệu doanh thu ===
    const customerSheet = workbook.addWorksheet('Khách hàng');
    customerSheet.columns = [
    { header: 'Thời gian', key: 'label', width: 20 },
    { header: 'Tổng',       key: 'total', width: 20 }
  ];
  // ghi data vào sheet
  customerData.forEach(r => customerSheet.addRow({ label: r.label, total: r.total }));
  // === Sheet 2: Biểu đồ ===
  const chartSheet = workbook.addWorksheet('Biểu đồ');
  // tăng scale để ảnh nét hơn
  const scaleFactor = 3;

  function getCanvasImageData(canvasId) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    // tạo canvas tạm với kích thước scaleFactor lần
    const temp = document.createElement('canvas');
    temp.width  = canvas.width  * scaleFactor;
    temp.height = canvas.height * scaleFactor;
    const ctx = temp.getContext('2d');
    ctx.scale(scaleFactor, scaleFactor);
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(canvas, 0, 0);
    return temp.toDataURL('image/png');
  }

  // thêm hình vào sheet ở vị trí dạng "A1:H20", "A22:H42", v.v.
  function addChartImage(canvasId, position) {
    const imgData = getCanvasImageData(canvasId);
    if (!imgData) return;
    const imgId = workbook.addImage({ base64: imgData, extension: 'png' });
    chartSheet.addImage(imgId, position);
  }

  // luôn xuất biểu đồ doanh thu ở trên
 addChartImage('customerChart', 'A1:H20');
  if (busType == "3") {
    // đặt biểu đồ khách hàng ngay dưới (ví dụ bắt đầu từ hàng 22)
    addChartImage('revenueChart', 'A22:H42');
  }

  // === Tên file theo ngày hiện tại ===
  const now = new Date();
  const formattedDate = now.toLocaleDateString('vi-VN', {
    day:   '2-digit',
    month: '2-digit',
    year:  'numeric'
  }).split('/').join('-');
  const fileName = `BaoCaoThongKe ${formattedDate}.xlsx`;

  // xuất file
  const buffer = await workbook.xlsx.writeBuffer();
  const blob   = new Blob([buffer], { type: 'application/octet-stream' });
  saveAs(blob, fileName);
}


function printReport() {
  // Giả sử busType đã có sẵn (ví dụ lấy từ form hoặc biến toàn cục)
  const busType = Number(id_businesstype || 0);
  console.log(busType)
  // 1. Chuyển Canvas thành ảnh
  const imgRev  = document.getElementById('revenueChart').toDataURL('image/png');
  const imgCust = document.getElementById('customerChart').toDataURL('image/png');

  // 2. Lấy ngày in
  const now = new Date();
  const printedDate = now.toLocaleDateString('vi-VN', {
    year: 'numeric', month: '2-digit', day: '2-digit'
  });

  // 3. Tạo phần section doanh thu nếu busType == "3"
  const revenueSection = busType == "3" ? `
    <section>
      <h2>1. Biểu đồ Doanh thu</h2>
      <img src="${imgRev}" alt="Biểu đồ Doanh thu">
    </section>
  ` : '';

  // 4. Xây dựng reportHTML với inline <style> để jQuery.print clone nguyên vẹn
  const reportHTML = `
    <style>
      @page { size: A4; margin: 20mm; }
      body { font-family: Arial, sans-serif; color: #333; }
      header { text-align: center; margin-bottom: 20px; }
      header h1 { margin: 0; font-size: 24px; }
      header .date { margin-top: 5px; font-size: 14px; color: #666; }
      section { page-break-inside: avoid; margin-bottom: 30px; }
      section h2 {
        font-size: 18px; border-bottom: 1px solid #ddd;
        padding-bottom: 5px; margin-bottom: 10px;
      }
      section img { display: block; max-width: 100%; height: auto; }
      footer {
        position: fixed; bottom: 10mm; left: 0; right: 0;
        text-align: center; font-size: 12px; color: #999;
      }
      .page-number:after { content: counter(page); }
    </style>

    <div class="report-content">
      <header>
        <h1>BIỂU ĐỒ BÁO CÁO</h1>
        <div class="date">Ngày in: ${printedDate}</div>
      </header>

      ${revenueSection}

      <section>
        <h2>${busType == "3" ? '2. ' : '1. '}Biểu đồ Số lượng khách hàng</h2>
        <img src="${imgCust}" alt="Biểu đồ Khách hàng">
      </section>

      <footer>
        Trang <span class="page-number"></span>
      </footer>
    </div>
  `;

  // 5. Tạo container tạm và in
  const $printContainer = $('<div id="printContainer"></div>')
    .html(reportHTML)
    .appendTo('body');

  $printContainer.print({
    globalStyles    : true,
    mediaPrint      : false,
    noPrintSelector : ".no-print",
    iframe          : true
  });

  // 6. Dọn dẹp
  $printContainer.remove();
}

// Gắn event cho nút
$('#exportPdfBtn').on('click', printReport);


$('#exportExcelBtn').click(exportExcel);
  // Khởi tạo khi document ready
  $(document).ready(function() {
    loadUsers();
    const now = new Date(), thisYear = now.getFullYear();
    $('#monthPicker').val(thisYear);
    $('#startYear').val(thisYear - 5);
    $('#endYear').val(thisYear);
    $('#statType').trigger('change');
    fetchRevenueByMonth(thisYear);
    if (id_businesstype < "3"){
        $('#mostCustomerCard').hide();
        $('#mostProductCard').hide();
        $('#revenuecard').hide();
        $('#ordercard').hide();
        $('#revenueChartCard').hide();

    }
    
    // Thêm BlockUI cho AJAX
  
  });
</script>

</body>
</html>
